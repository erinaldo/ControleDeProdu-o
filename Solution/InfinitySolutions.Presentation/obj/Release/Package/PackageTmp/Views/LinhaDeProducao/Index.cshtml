@using InfinitySolutions.Entity
@using InfinitySolutions.Commom
@using InfinitySolutions.Entity.Enum
@using InfinitySolutions.Commom.Dtos
@model InfinitySolutions.Presentation.Models.LinhaDeProducaoModel
@{
    ViewBag.Title = "Linha de Produção";
    ViewBag.Imagem = "~/Content/imagens/LinhaProducao.png";

    string ClasseMensagem = Model.Retorno.IsValido ? "alert-success" : "alert-danger";
    string ClasseVisivel = !String.IsNullOrEmpty(@Model.Retorno.Mensagem) ? String.Empty : "invisivel";
    var login = Session[Constantes.USUARIO_LOGADO] as Login;
}


@using (Html.BeginForm("Salvar", "LinhaDeProducao", FormMethod.Post, new { @class = "form-horizontal", id = "formLinhaDeProducao" }))
{
    <div class="row tabela-inicio">
        <div class="col-lg-12 col-md-12 col-xs-12">
            <div class="jumbotron">
                <div id="divMensagem" class="alert @ClasseMensagem @ClasseVisivel js-mensagem" role="alert">
                    <label><span id="spanMensagem" class="js-escrita-mensagem">@Model.Retorno.Mensagem</span></label>
                </div>
                <div class="form-group">
                    <div class="col-lg-2 col-md-2 col-xs-2">
                        <label><span class="fonte-vermelha control-label">* </span>Data Inicio</label>
                        @Html.TextBoxFor(m => m.DataInicio, new { id = "txtContasPagarDataInicio", @class = "form-control js-obrigatorio js-data" })
                    </div>
                    <div class="col-lg-2 col-md-2 col-xs-2">
                        <label><span class="fonte-vermelha control-label">* </span>Data Fim</label>
                        @Html.TextBoxFor(m => m.DataFim, new { id = "txtContasPagarDataFim", @class = "form-control js-obrigatorio js-data" })
                    </div>

                    <div class="col-lg-1 col-md-1 col-xs-1">
                        <button id="btnLinhaDeProducaoPesquisar" type="button" class="btn btn-info">
                            Pesquisar
                        </button>
                    </div>
                </div>
            </div>

            <div class="jumbotron">
                <table id="tblLinhaProducao" class="table table-striped">
                    <thead>
                        <tr>
                            <th scope="col">QUANTIDADE</th>
                            <th scope="col">PRODUTO</th>
                            <th scope="col">INICIO</th>
                            <th scope="col">FIM</th>
                            <th scope="col">COLABORADORES</th>
                            <th scope="col">STATUS</th>
                            <th scope="col">PEDIDO</th>
                            <th scope="col">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>

                        @if (Model.Retorno.Entity != null)
                        {
                            foreach (var linhaProducaoProduto in ((LinhaProducaoExibicaoDto)Model.Retorno.Entity).LinhaProducaoProdutos)
                            {
                                var nomesAssociados = linhaProducaoProduto.EhTerceirizado ? linhaProducaoProduto.Terceirizado.Nome : linhaProducaoProduto.NomesFuncionarios;

                                var status = linhaProducaoProduto.TipoStatusLinhaProducao.Codigo != (int)EnumTipoStatusLinhaProducao.PRODUZIDO
                                    && linhaProducaoProduto.DataPrevisaoFim < DateTime.Now ? EnumTipoStatusLinhaProducao.ATRASADO.RecuperaDescricaoEnum() :
                                    linhaProducaoProduto.TipoStatusLinhaProducao.Descricao;

                                var dataPrevisaoInicio = linhaProducaoProduto.EhTerceirizado ? linhaProducaoProduto.DataPrevisaoInicio.ToString("dd/MM/yyyy") : linhaProducaoProduto.DataPrevisaoInicio.ToString("dd/MM/yyyy HH:mm");
                                var dataPrevisaoFim = linhaProducaoProduto.EhTerceirizado ? linhaProducaoProduto.DataPrevisaoFim.ToString("dd/MM/yyyy") : linhaProducaoProduto.DataPrevisaoFim.ToString("dd/MM/yyyy HH:mm");
                                var codigoLinhaProducaoCodigoPedidoProduto = String.Concat(linhaProducaoProduto.Codigo, "|", linhaProducaoProduto.Produto.CodigoPedidoProduto);

                                <tr>
                                    <td scope="col">@linhaProducaoProduto.Produto.Quantidade.Value.ToString("00")</td>
                                    <td scope="col">@linhaProducaoProduto.Produto.DescricaoCompleta</td>
                                    <td scope="col">@dataPrevisaoInicio</td>
                                    <td scope="col">@dataPrevisaoFim</td>
                                    <td scope="col">@Html.Raw(nomesAssociados)</td>
                                    <td scope="col">@status</td>
                                    <td scope="col">@linhaProducaoProduto.Pedido.Codigo.ToString("0000000")</td>
                                    <td scope="col">
                                        @if (linhaProducaoProduto.TipoStatusLinhaProducao.Codigo != (int)EnumTipoStatusLinhaProducao.PRODUZIDO)
                                        {
                                            <img id="@linhaProducaoProduto.Produto.CodigoPedidoProduto" src="~/Content/imagens/DAR BAIXA.png" alt="CONFIRMAR PRODUÇÃO" title="CONFIRMAR PRODUÇÃO" class="js-ConfirmarProducao" />
                                        }
                                        @if (!linhaProducaoProduto.EhTerceirizado && status == EnumTipoStatusLinhaProducao.ATRASADO.RecuperaDescricaoEnum())
                                        {
                                            <img id="@codigoLinhaProducaoCodigoPedidoProduto" src="~/Content/imagens/Terceirizar.png" alt="TERCEIRIZAR PRODUÇÃO" title="TERCEIRIZAR PRODUÇÃO" class="js-TerceirizarProducao" />
                                        }

                                        <img id="@codigoLinhaProducaoCodigoPedidoProduto" src="~/Content/imagens/ConfirmarTerceirizar.png" alt="CONFIRMAR TERCEIRIZAR PRODUÇÃO" title="CONFIRMAR TERCEIRIZAR PRODUÇÃO" class="js-ConfirmarTerceirizarProducao invisivel" />
                                    </td>
                                </tr>
                            }
                        }

                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<script src="~/Scripts/LinhaDeProducao/index.js"></script>